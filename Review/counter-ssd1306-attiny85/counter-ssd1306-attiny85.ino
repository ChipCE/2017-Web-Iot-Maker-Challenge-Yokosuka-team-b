/*

 *   RESET   -|_|  |- 5V
 *   SCL (3) -|    |- (2) PING_OUT
 *   SDA (4) -|    |- (1) PING_IN
 *   GND     -|____|- (0)
 
 *   OUTDOOR - PING_OUT - DOOR - PING_IN INDOOR

*/

#include "ssd1306.h"
#include "font6x8.h"

//Config
#define PING_OUT 2
#define PING_IN 1
#define THRESHOLD 24
#define TIMEOUT 3000
#define LOOPDELAY 1000

//image
const uint8_t logo [] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x40, 0x40, 0x20, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04,
0x02, 0x02, 0x04, 0x04, 0x08, 0x08, 0x10, 0x10, 0x20, 0x40, 0x40, 0x80, 0x80, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80,
0x80, 0x00, 0x00, 0x00, 0xC0, 0x80, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x40, 0x20, 0x20, 0x10, 0x08, 0x08,
0x04, 0x04, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02,
0x04, 0x04, 0x08, 0x08, 0x10, 0x20, 0x20, 0x40, 0x40, 0x80, 0x80, 0x00, 0x00, 0x1F, 0x31, 0x2E,
0x2A, 0x2D, 0x0F, 0x00, 0x01, 0x03, 0x3E, 0x3C, 0x03, 0x01, 0x00, 0x1C, 0x3E, 0x22, 0x22, 0x3E,
0x1C, 0x00, 0x3F, 0x3F, 0x08, 0x0C, 0x32, 0x32, 0x00, 0x1C, 0x3E, 0x22, 0x22, 0x3E, 0x1C, 0x00,
0x16, 0x26, 0x2A, 0x2A, 0x32, 0x34, 0x00, 0x1E, 0x3E, 0x20, 0x1E, 0x3E, 0x20, 0x00, 0x3F, 0x3F,
0x08, 0x0C, 0x32, 0x32, 0x00, 0x18, 0x3E, 0x26, 0x1E, 0x3C, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x3F, 0x3F, 0x3F, 0x20, 0x3F, 0x3F, 0x3F, 0x30, 0x3F, 0x3F, 0x3F, 0x00, 0x3F, 0x3F,
0x3F, 0x29, 0x29, 0x29, 0x29, 0x00, 0x3F, 0x3F, 0x3F, 0x3F, 0x33, 0x33, 0x3F, 0x3F, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0xF8, 0x08, 0x08, 0x00,
0x00, 0xF8, 0x48, 0x48, 0x48, 0x00, 0x00, 0xF0, 0x48, 0x48, 0x48, 0xF0, 0x00, 0x00, 0xF8, 0x08,
0x08, 0xF8, 0x08, 0x08, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x48, 0x48, 0x48, 0xB0, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x41, 0x22, 0x14, 0x08, 0x14, 0x22, 0x41, 0x00, 0x00, 0x7F, 0x7F, 0x7F, 0x00,
0x7E, 0x7E, 0x72, 0x72, 0x7E, 0x7E, 0x7E, 0x00, 0x03, 0x03, 0x7F, 0x7F, 0x7F, 0x7F, 0x03, 0x03,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x80, 0x80, 0x03, 0x80, 0x80, 0x80,
0x00, 0x83, 0x82, 0x82, 0x02, 0x80, 0x00, 0x03, 0x80, 0x80, 0x00, 0x03, 0x00, 0x00, 0x83, 0x80,
0x00, 0x83, 0x80, 0x80, 0x03, 0x80, 0x00, 0x80, 0x00, 0x80, 0x83, 0x02, 0x02, 0x82, 0x83, 0x80,
0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x60, 0x90, 0x0C, 0x04, 0x04, 0x04, 0x07, 0x04, 0x04, 0x24, 0x84, 0xF4, 0x74, 0x04, 0x04, 0x44,
0xE4, 0xD4, 0x24, 0xE4, 0x34, 0xE4, 0xE4, 0x04, 0x04, 0x04, 0x04, 0x04, 0x94, 0xF4, 0x74, 0x94,
0x14, 0x04, 0x14, 0xF4, 0x74, 0x14, 0x04, 0xE4, 0x84, 0x44, 0x04, 0xF4, 0x84, 0x84, 0x04, 0x14,
0x14, 0xC4, 0xF4, 0x34, 0x14, 0x94, 0xE4, 0x74, 0x14, 0x04, 0x04, 0x07, 0x04, 0x04, 0x04, 0x0C,
0x90, 0x60, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x02, 0x03, 0x00, 0x0F, 0x0A, 0x00, 0x0F, 0x08, 0x0F,
0x00, 0x0F, 0x02, 0x03, 0x00, 0xCF, 0x48, 0x80, 0x0F, 0xCA, 0x40, 0x00, 0xC0, 0x40, 0x8F, 0x48,
0x80, 0x0F, 0xC8, 0x4F, 0xC0, 0x0F, 0x08, 0x0F, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x00, 0x0F, 0x00,
0x00, 0x0F, 0x0A, 0x00, 0x0F, 0x02, 0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x03, 0x02, 0x02, 0x02, 0xFE, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x62, 0x62, 0x62, 0x62, 0xE2, 0xE2, 0xE2, 0x02, 0xE2, 0xE2, 0x62, 0x62,
0xE2, 0xE2, 0x02, 0x62, 0xE2, 0xE2, 0x02, 0xE2, 0xE2, 0xE2, 0x62, 0xE2, 0xE2, 0xE2, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0xFE, 0x02, 0x02, 0x02, 0x03,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x04, 0x03, 0x00, 0x07, 0x05, 0x00, 0x07, 0x00, 0x07, 0x00,
0x07, 0x00, 0x07, 0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x04, 0x04, 0x08, 0x08, 0x10, 0x10,
0x20, 0x20, 0x40, 0x80, 0x87, 0x07, 0x07, 0x05, 0x05, 0x05, 0x05, 0x00, 0x07, 0x07, 0x06, 0x06,
0x07, 0x07, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x87, 0x80, 0x40,
0x40, 0x20, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x04, 0x04, 0x08, 0x08, 0x10, 0x10, 0x20, 0x40,
0x40, 0x40, 0x40, 0x20, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x14, 0x1C, 0x00, 0x1C, 0x04, 0x18, 0x00, 0x00, 0x1F,
0x05, 0x1F, 0x00, 0x01, 0x1F, 0x01, 0x00, 0x01, 0x1F, 0x01, 0x00, 0x1F, 0x00, 0x1F, 0x01, 0x1E,
0x00, 0x03, 0x1C, 0x03, 0x00, 0x1F, 0x15, 0x1F, 0x00, 0x17, 0x15, 0x1D, 0x00, 0x00, 0x00, 0x00
};

void displayLogo()
{
  ssd1306_drawBitmap(0, 0, 128, 64, logo);
  delay(2000);
  ssd1306_clearScreen();
}

//Data
int inCounter;
int outCounter;

void initData()
{
  inCounter = 0;
  outCounter = 0;
}

long microsecondsToCentimeters(long microseconds)
{
  return microseconds / 29 / 2;
}

int isTriggered(int pin)
{
  pinMode(pin, OUTPUT);
  digitalWrite(pin, LOW);
  delayMicroseconds(2);
  digitalWrite(pin, HIGH);
  delayMicroseconds(5);
  digitalWrite(pin, LOW);
  pinMode(pin, INPUT);
  long duration = pulseIn(pin, HIGH);
  long cm = microsecondsToCentimeters(duration);
  if (cm <= THRESHOLD)
    return 1;
  return 0;
}



void resetDisplay()
{
  //display startup logo
  displayLogo();
  //display frame
  ssd1306_printFixed(0, 0," People counter demo", STYLE_NORMAL);
  ssd1306_drawLine(0,12, ssd1306_displayWidth() -1, 12);

  initData();
  updateDisplay();
}

void setup()
{
  ssd1306_128x64_i2c_init();
  ssd1306_fillScreen(0x00);
  ssd1306_setFixedFont(ssd1306xled_font6x8);
  resetDisplay();
}

char intToC(int num)
{
  return '0'+num;
}

void updateDisplay()
{
  //reset counter if needed
  if(inCounter>9 || outCounter>9)
    resetDisplay();

  char str[] = "IN  :      OUT :  ";
  str[6]=intToC(inCounter);
  str[17]=intToC(outCounter);
  ssd1306_printFixed(0, 40, str, STYLE_NORMAL);
}

void loop()
{
  int delayFlag = 0;

  char sensorStr[]= "Sensor1:x  Sensor2:x";
  ssd1306_printFixed(0, 24,sensorStr, STYLE_NORMAL);  

  int s0 = isTriggered(PING_OUT);
  int s1 = isTriggered(PING_IN);

  int oldIn = inCounter;
  int oldOut = outCounter;

  if (s0 || s1)
  {
    if (s0)
    {
      //set start time out
      unsigned long strigTime = millis();

      //update sensorStr
      sensorStr[8]='o';
      sensorStr[19]='w';
      ssd1306_printFixed(0, 24,sensorStr, STYLE_NORMAL);

      //wait for other sensor trigger
      while (!isTriggered(PING_IN) != 0 && (millis() - strigTime < TIMEOUT))
        ;
      sensorStr[19]='o';
      ssd1306_printFixed(0, 24,sensorStr, STYLE_NORMAL);


      //and wait for it out of range
      while (isTriggered(PING_IN) == 1 && (millis() - strigTime < TIMEOUT))
        ;

      sensorStr[8]='x';
      sensorStr[19]='x';
      ssd1306_printFixed(0, 24,sensorStr, STYLE_NORMAL);

      //check TIMEOUT
      if (millis() - strigTime < TIMEOUT)
      {
        inCounter++;
        delayFlag = 1;
      }
      else
      {
        //ignore
      }
    }
    else if (s1)
    {
      //set star time out
      unsigned long strigTime = millis();

      sensorStr[8]='w';
      sensorStr[19]='o';
      ssd1306_printFixed(0, 24,sensorStr, STYLE_NORMAL);

      //wait for other sensor trigger
      while (!isTriggered(PING_OUT) != 0 && (millis() - strigTime < TIMEOUT))
        ;

      sensorStr[8]='o';
      ssd1306_printFixed(0, 24,sensorStr, STYLE_NORMAL);
      
      //and wait for it out of range
      while (isTriggered(PING_OUT) == 1 && (millis() - strigTime < TIMEOUT))
        ;

      sensorStr[8]='x';
      sensorStr[19]='x';
      ssd1306_printFixed(0, 24,sensorStr, STYLE_NORMAL);

      //check TIMEOUT
      if (millis() - strigTime < TIMEOUT)
      {
        outCounter++;
        delayFlag = 1;
      }
      else
      {
        //ignore
      }
    }
  }

  if (oldIn != inCounter || oldOut != outCounter)
  {
    //update display
    updateDisplay();
  }

  if (delayFlag)
  {
    ssd1306_printFixed(0, 56,"Status : Busy ", STYLE_NORMAL);  
    delay(LOOPDELAY);
  }
  ssd1306_printFixed(0, 56,"Status : Ready", STYLE_NORMAL);  
}